<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RM Tasks</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--black:#0f0f0f;--orange:#ff9f1a;--gray:#1e1e1e;
--text:#f5f5f5;--red:#ff4d4d;--yellow:#ffc107;--green:#4caf50}
body{margin:0;font-family:Arial;background:var(--black);color:var(--text)}
header{padding:20px;border-bottom:2px solid var(--orange)}
h1,h2{color:var(--orange);margin:0}
main{padding:20px;display:grid;grid-template-columns:1fr 1fr;gap:20px}
section{background:var(--gray);padding:20px;border-radius:14px}
input,textarea,button{padding:8px;border-radius:8px;border:none;font-size:14px}
input,textarea{background:#2b2b2b;color:#fff;width:100%}
button{cursor:pointer;font-weight:bold}
.primary{background:var(--orange)}
.secondary{background:#333;color:#fff}
.small{padding:4px 8px;font-size:12px}

.item{background:#141414;padding:12px;border-radius:12px;margin-top:10px}
.item-top{display:flex;gap:10px;align-items:center}
.item-info{flex:1}
.qty-label{color:var(--orange);font-weight:bold}
.progress-container{background:#333;border-radius:8px;height:20px;overflow:hidden}
.progress-bar{height:100%;line-height:20px;font-weight:bold;color:#000}
.item-buttons{display:flex;gap:4px}

.task-list{list-style:none;padding:0;margin-top:10px}
.task-list li{padding:10px;border-radius:10px;display:flex;justify-content:space-between;margin-bottom:6px}
.task-buttons{display:flex;gap:4px}
.task-color{width:44px;height:32px;border:none;border-radius:6px}
.done{text-decoration:line-through;opacity:.5}
</style>
</head>

<body>

<header><h1>RM Tasks</h1></header>

<main>
<section>
<h2>Офис RM</h2>

<!-- Поле поиска -->
<input type="text" id="itemSearch" placeholder="Поиск товара..." style="margin-bottom:10px">

<input id="itemName" placeholder="Название товара">
<input id="itemQty" type="number" placeholder="Количество">
<input id="itemFile" type="file" accept="image/*">
<button class="primary" id="addItemBtn">Добавить</button>
<div id="itemsList"></div>
</section>

<section>
<h2>Задачи RM</h2>
<textarea id="taskText" placeholder="Текст задачи"></textarea>
<input id="taskDeadline" type="datetime-local">
<input type="color" id="taskColor" value="#ff9f1a" class="task-color">
<button class="primary" id="addTaskBtn">Добавить</button>
<ul id="tasksContainer" class="task-list"></ul>
</section>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
const WA_NUMBER = '77074052052';

const firebaseConfig = {
 apiKey: "AIzaSyDyLHYbxuhQn8-vpEXBqhQ7z2UPh1JvFt0",
 authDomain: "taskrm-69472.firebaseapp.com",
 projectId: "taskrm-69472"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

document.addEventListener('DOMContentLoaded',()=>{

/* WHATSAPP */
function sendWA(name){
 const text = `❗ Товар: ${name}\nКоличество меньше 5 шт, нужно заказать`;
 window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`,'_blank');
}

/* ADD ITEM */
addItemBtn.onclick = async ()=>{
 const n=itemName.value.trim();
 const q=+itemQty.value;
 if(!n||!q) return alert('Заполни данные');

 let img='';
 if(itemFile.files[0]){
  const r=new FileReader();
  r.onload=async e=>{
   img=e.target.result;
   await db.collection('items').add({n,q,max:q,img,notified:false});
   itemName.value=itemQty.value=itemFile.value='';
   renderItems();
  };
  r.readAsDataURL(itemFile.files[0]);
 } else {
  await db.collection('items').add({n,q,max:q,img:'',notified:false});
  itemName.value=itemQty.value='';
  renderItems();
 }
};

/* RENDER ITEMS */
async function renderItems(){
 itemsList.innerHTML='';
 const snap=await db.collection('items').get();

 snap.forEach(doc=>{
  const it=doc.data();

  if(it.q < 5 && !it.notified){
    sendWA(it.n);
    db.collection('items').doc(doc.id).update({notified:true});
  }

  let c = it.q < 2 ? 'var(--red)' : it.q < 5 ? 'var(--yellow)' : 'var(--green)';
  let p = Math.max(0,Math.round(it.q / it.max * 100));

  const div=document.createElement('div');
  div.className='item';
  div.innerHTML=`
  <div class="item-top">
   ${it.img?`<img src="${it.img}" width="50">`:''}
   <div class="item-info">
    <strong>${it.n}</strong>
    <div class="qty-label">Количество</div>
    <div class="progress-container">
     <div class="progress-bar" style="width:${p}%;background:${c}">${it.q}</div>
    </div>
   </div>
   <div class="item-buttons">
    <button class="small primary" onclick="issue('${doc.id}',${it.q})">Выдал</button>
    <button class="small secondary" onclick="editItem('${doc.id}','${it.n}',${it.q})">Ред</button>
    <button class="small secondary" onclick="delItem('${doc.id}')">✕</button>
   </div>
  </div>`;
  itemsList.appendChild(div);
 });
}

/* ПОИСК ТОВАРОВ */
document.getElementById('itemSearch').addEventListener('input', function(){
 const query = this.value.toLowerCase();
 const items = document.querySelectorAll('#itemsList .item');
 items.forEach(it=>{
   const name = it.querySelector('strong').textContent.toLowerCase();
   it.style.display = name.includes(query) ? 'flex' : 'none';
 });
});

window.issue = async(id,q)=>{
 if(q<=0) return;
 await db.collection('items').doc(id).update({q:q-1});
 renderItems();
};

window.editItem = async(id,n,q)=>{
 const nn = prompt('Название',n);
 const nq = prompt('Количество',q);
 if(nn!==null && nq!==null){
  await db.collection('items').doc(id).update({
    n:nn,
    q:+nq,
    max:Math.max(+nq,1),
    notified:false
  });
  renderItems();
 }
};

window.delItem = async(id)=>{
 if(confirm('Удалить товар?')){
  await db.collection('items').doc(id).delete();
  renderItems();
 }
};

/* TASKS */
addTaskBtn.onclick = async ()=>{
 const t=taskText.value.trim();
 if(!t) return;
 await db.collection('tasks').add({
  t,color:taskColor.value,dl:taskDeadline.value,done:false
 });
 taskText.value='';
 renderTasks();
};

async function renderTasks(){
 tasksContainer.innerHTML='';
 const snap=await db.collection('tasks').get();
 snap.forEach(doc=>{
  const t=doc.data();
  const li=document.createElement('li');
  li.style.background=t.color;
  if(t.done) li.classList.add('done');
  li.innerHTML=`
   <span>${t.t}</span>
   <div class="task-buttons">
    <button class="small primary" onclick="toggleTask('${doc.id}',${t.done})">✔</button>
    <button class="small secondary" onclick="delTask('${doc.id}')">✕</button>
    <input type="color" class="task-color" value="${t.color}"
      onchange="colorTask('${doc.id}',this.value)">
   </div>`;
  tasksContainer.appendChild(li);
 });
}

window.toggleTask=async(id,d)=>{await db.collection('tasks').doc(id).update({done:!d});renderTasks();}
window.delTask=async(id)=>{if(confirm('Удалить задачу?')){await db.collection('tasks').doc(id).delete();renderTasks();}}
window.colorTask=async(id,c)=>{await db.collection('tasks').doc(id).update({color:c});}

renderItems();
renderTasks();
</script>

</body>
</html>
